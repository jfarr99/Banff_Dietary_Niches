---
title: "FOO_analyses"
output: html_document
date: "2024-07-26"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(phyloseq)
library(vegan)
library(metagMisc)
library(spaa)
library(microViz)

```


Read in data
```{r}
physeq_rarefy_rra <- readRDS("banff_diet_phyloseq_cleaned_Dec032024.rds")
physeq_foo <- phyloseq_standardize_otu_abundance(physeq_rarefy_rra, method = "pa")


sample_data(physeq_foo)$Season = factor(sample_data(physeq_foo)$Season, 
                                         levels = c("Spring", "Summer", "Winter", "Fall"), 
                                         labels = c("Spring", "Summer", "Winter", "Winter"))
sample_data(physeq_foo)$Season = factor(sample_data(physeq_foo)$Season, 
                                         levels = c("Spring", "Summer", "Winter", "Fall"), 
                                         labels = c("Spring", "Summer", "Winter", "Winter"))


physeq_df <- psmelt(physeq_rarefy_rra) %>%
   mutate(Sample_description = paste(Sample, Date, General_Loc, sep = ":")) %>%   # informative label we might use for plotting
  # now paste together our family/genera/species 
 # mutate(species_name = ifelse(is.na(species_name), genus_name, species_name )) %>% 
  mutate(family_genus_species = paste(family_name, species_name, sep=":"), 
          family_genus = paste(family_name, genus_name, sep = ":")) %>% 
  mutate(Present = ifelse(Abundance > 0, 1, 0))# %>% # this is adding a binary presence/absence variable 
  #filter(Present == 1) # remove all "0" rows as# these are non-informative for everything we're trying to do here. 

```


Re-creating figure 1 based on FOO data! 
```{r}
#Trying to make a SankeyDiagram - this is still janky 
spp_data <- physeq_df %>%
  group_by(Species) %>%
  mutate(Seasonal_samples = n_distinct(Sample)) %>%  # number of unique samples in the season 
  group_by(Species, form, identity) %>% 
  summarise(FOO = sum(Present)/unique(Seasonal_samples)*100, 
            Seasonal_samples = unique(Seasonal_samples))  %>% 
  group_by(Species) %>% 
  mutate(POO = FOO/sum(FOO))

spp_data <- spp_data %>% 
  mutate(form= if_else(form == "moss", "other", form)) %>% 
  mutate(form= if_else(is.na(form), "other", form)) %>% 
  mutate(Species = if_else(Species == "BighornSheep", "Bighorn Sheep", Species))


spp_data$form = factor(spp_data$form, levels = c("grass", "non-grass graminoid", "forb",
                                                 "deciduous shrub/tree",
                                                 "coniferous shrub/tree"), 
                                    labels = c("Grass", "Non-grass graminoids", "Forbs", 
                                               "Deciduous shrubs", 
                                               "Coniferous shrubs"))
spp_data$Species = factor(spp_data$Species, levels = c("Bison", "Bighorn Sheep", 
                                                       "Elk", "Deer", "Goat", "Moose"), 
                          labels = c("Bison", "Bighorn Sheep", 
                                                       "Elk", "Deer", "Mountain Goat", "Moose"))

spp_data$allszn = "All Seasons"

ggplot(spp_data,
       aes(x = Species, fill = form, y = POO)) +
  geom_col(color = "grey20", alpha = 0.8) + 
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) + 
  labs(y = "Percent Frequency of Occurrence (%)", x = NULL) +
  theme_bw() +
  facet_wrap(.~allszn, strip.position = "right") + 
  theme(
    axis.ticks = element_blank(),
    legend.position = "bottom", 
    legend.title = element_blank(),
    panel.grid.major = element_blank(),  # Remove major gridlines
    panel.grid.minor = element_blank()
  ) + 
  scale_fill_manual(values = c("gold", "lightyellow2", "darkorchid", "forestgreen", "brown"),
                    na.value = "grey90") 

ggsave("Outputs/FOO_all_species_diets_noSeason_dec072024.jpeg", width = 6, height = 6)


########################################
#Trying to make a SankeyDiagram 
physeq_sankey_data <- physeq_df %>%
    mutate(Season = if_else(Season == "Fall", "Winter", Season)) %>% 
  group_by(Species, Season) %>%
  mutate(Seasonal_samples = n_distinct(Sample)) %>%
  group_by(Species, Season, form) %>%
  summarise(FOO = sum(Present)/unique(Seasonal_samples)*100, 
            Seasonal_samples = unique(Seasonal_samples))  %>% 
  group_by(Species) %>% 
  mutate(POO = FOO/sum(FOO)) 


physeq_sankey_PLOTdat <- physeq_sankey_data %>% 
  filter(Species != "Moose" & Species != "Deer" & Species != "Goat") %>% 
  mutate(form= if_else(is.na(form) | form == "moss", "other", form))


physeq_sankey_PLOTdat$form = factor(physeq_sankey_PLOTdat$form, levels = rev(c("grass", "non-grass graminoid", "forb", 
                                                                     "deciduous shrub/tree",
                                                                     "coniferous shrub/tree")))
#physeq_sankey_PLOTdat$labels = factor(physeq_sankey_PLOTdat$form, labels = rev(c("G", "F", 
                                                                     #"SD", "SC")))


physeq_sankey_PLOTdat$Season = factor(physeq_sankey_PLOTdat$Season, levels = c("Winter", "Spring", "Summer"))

physeq_sankey_PLOTdat$Species = factor(physeq_sankey_PLOTdat$Species, 
                                       levels = c("Elk", "BighornSheep", "Bison"), 
                                       labels = c("Elk", "Bighorn Sheep", "Bison"))

ggplot(physeq_sankey_PLOTdat,
       aes(axis1 = form, axis2 = Species, y = POO)) +
  geom_alluvium(aes(fill = form), width = 1/10, color = "black", alpha = 0.8) +
  geom_stratum(width = 1/10, aes(fill = form), color = "black") +
#  geom_text(stat = "stratum", infer.label = TRUE) +
  scale_x_discrete(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportional Read Abundance (%)") +
  facet_wrap(.~Season, nrow = 3,  strip.position = "right", scales = "free_x") +
  theme_bw() +
  theme(
   axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.position = "none", 
    panel.grid.major = element_blank(),  # Remove major gridlines
    panel.grid.minor = element_blank()
  ) + 
  scale_fill_manual(values = rev(c("gold", "lightyellow2", "darkorchid", "forestgreen", "brown")),
                    na.value = "white")+ 
  coord_flip()

ggsave("Outputs/FOO_seasonal_diets_dec072024.jpeg", width = 5, height = 6)

```

Indicator species analysis based on FOO 
```{r}
######## FOR ALL SPECIES - ignoring season  ############
# get our OTU matrix and our sample metadata 
otu_matrix <- as.data.frame(otu_table(physeq_foo))
sample_metadata <- sample_data(physeq_foo)
# Add taxonomy to the OTU table
otu_with_tax <- cbind(otu_matrix, tax_table(physeq_foo))
groups <-sample_metadata$Species # our grouping variable = species 
groups <- factor(groups)


####### grouped by functional form  
otu_by_form <- otu_with_tax %>%
  group_by(form) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE)) %>% 
  filter(!is.na(form))

otu_by_form <- t(otu_by_form) # transpose
colnames(otu_by_form) <- otu_by_form[1,] # make labels first row) 
otu_by_form <- otu_by_form[-1,] # remove row with labels (character)
otu_by_form <- apply(otu_by_form, 2, as.numeric) # convert to numeric! 

form_allszn <- multipatt(otu_by_form, groups, func = "r.g", control = how(nperm=999))[["sign"]]
write.csv(form_allszn, "Outputs/FOO_form_indicspp_allspp.csv")

### GROUP BY mOTU then we can assign stuff post-hoc! 
otu_by_motu <- otu_with_tax %>%
  group_by(identity) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE))

otu_by_motu <- t(otu_by_motu) # transpose
colnames(otu_by_motu) <- otu_by_motu[1,] # make labels first row) 
otu_by_motu <- otu_by_motu[-1,] # remove row with labels (character)
otu_by_motu <- apply(otu_by_motu, 2, as.numeric) # convert to numeric! 

# need to find a way to remove mOTUs that are rare based on RRA..... 
otu_matrix2 <- as.data.frame(otu_table(physeq_rarefy_rra))
otu_with_tax2 <- cbind(otu_matrix2, tax_table(physeq_rarefy_rra))
otu_by_motu2 <- otu_with_tax2 %>%
  group_by(identity) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE))
otu_by_motu2 <- t(otu_by_motu2) # transpose
colnames(otu_by_motu2) <- otu_by_motu2[1,] # make labels first row) 
otu_by_motu2 <- otu_by_motu2[-1,] # remove row with labels (character)
otu_by_motu2 <- apply(otu_by_motu2, 2, as.numeric) # convert to numeric! 

### YEEE! 
otu_by_motu[otu_by_motu2 < 0.01] <- 0# ignore mOTUs with miniscule representation (<0.1% of diet) or 


mOTU_allszn <- multipatt(otu_by_motu, groups, func = "r.g", control = how(nperm=999))[["sign"]]
mOTU_allszn$identity = rownames(mOTU_allszn)
mOTU_allszn <- left_join(mOTU_allszn, otu_with_tax[,262:284]) 

write.csv(mOTU_allszn, "Outputs/FOO_mOTU_indicspp_allspp.csv")

###################################################
# seasonal diets 
physeq_foo_subset <- subset_samples(physeq_foo, (Species == "Bison" | Species == "BighornSheep"
                                           | Species == "Elk") & Season != "Fall" )

otu_matrix <- as.data.frame(otu_table(physeq_foo_subset))
sample_metadata <- sample_data(physeq_foo_subset)
# Add taxonomy to the OTU table
otu_with_tax <- cbind(otu_matrix, tax_table(physeq_foo_subset))
groups <-paste(sample_metadata$Species, sample_metadata$Season, sep = "_") # our grouping variable = species 
groups <- factor(groups)

####### grouped by functional form  
otu_by_form <- otu_with_tax %>%
  group_by(form) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE)) %>% 
  filter(!is.na(form) & form != "moss")

otu_by_form <- t(otu_by_form) # transpose
colnames(otu_by_form) <- otu_by_form[1,] # make labels first row) 
otu_by_form <- otu_by_form[-1,] # remove row with labels (character)
otu_by_form <- apply(otu_by_form, 2, as.numeric) # convert to numeric! 

szn_form <- multipatt(otu_by_form, groups, func = "r.g",  control = how(nperm=999))[["sign"]]

write.csv(szn_form, "Outputs/FOO_form_indicspp_seasonal_diets.csv")




### GROUP BY mOTU then we can assign stuff post-hoc! 
otu_by_motu <- otu_with_tax %>%
  group_by(identity) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE))

otu_by_motu <- t(otu_by_motu) # transpose
colnames(otu_by_motu) <- otu_by_motu[1,] # make labels first row) 
otu_by_motu <- otu_by_motu[-1,] # remove row with labels (character)
otu_by_motu <- apply(otu_by_motu, 2, as.numeric) # convert to numeric! 

# removing rare species 
physeq_rra_subset <- subset_samples(physeq_rarefy_rra, (Species == "Bison" | Species == "BighornSheep"
                                           | Species == "Elk") & Season != "Fall" )
otu_matrix2 <- as.data.frame(otu_table(physeq_rra_subset))
otu_with_tax2 <- cbind(otu_matrix2, tax_table(physeq_rra_subset))
otu_by_motu2 <- otu_with_tax2 %>%
  group_by(identity) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE))
otu_by_motu2 <- t(otu_by_motu2) # transpose
colnames(otu_by_motu2) <- otu_by_motu2[1,] # make labels first row) 
otu_by_motu2 <- otu_by_motu2[-1,] # remove row with labels (character)
otu_by_motu2 <- apply(otu_by_motu2, 2, as.numeric) # convert to numeric! 

### YEEE! 
otu_by_motu[otu_by_motu2 < 0.01] <- 0# ignore mOTUs with miniscule representation (<0.1% of diet) or 

mOTU_allszn <- multipatt(otu_by_motu, groups, func = "r.g", control = how(nperm=999))[["sign"]]
mOTU_allszn$identity = rownames(mOTU_allszn)
mOTU_allszn <- left_join(mOTU_allszn, otu_with_tax[,237:260]) 

write.csv(mOTU_allszn, "Outputs/FOO_mOTU_indicspp_seasonal_diets.csv")

```



diversity indices 
```{r}
library(hilldiv) # for calculating hill numbers! 


# need to convert OTU matrix to binary 
otu_matrix <- as.data.frame(otu_table(physeq_foo))
sample_metadata <- sample_data(physeq_foo)

# Calculate Hill numbers for each sample RICHNESS
hill_rich <- hilldiv::hill_div(otu_matrix, qvalue = 0)
hill_div <- hilldiv::hill_div(otu_matrix, qvalue = 1)

# Combine results with sample metadata
hill_rich <- tibble::rownames_to_column(as.data.frame(hill_rich), var = "SampleID") %>% 
  mutate(metric = "q0") %>% dplyr::select(SampleID, metric, value = "hill_rich")
hill_div <- tibble::rownames_to_column(as.data.frame(hill_div), var = "SampleID")%>% 
  mutate(metric = "q1") %>% dplyr::select(SampleID, metric, value = "hill_div")

hill <- rbind(hill_rich, hill_div)

div_metrics <- left_join(hill, sample_metadata,  by = "SampleID") %>% 
  filter(Season != "Fall") %>% 
  group_by(Species, metric) %>% 
  summarise(mean = mean(value), 
           sd = sd(value), 
           n = n()) %>% 
  mutate(ci = 1.95*sd/sqrt(n), 
         se = sd/sqrt(n)) %>% 
  mutate(Season = "All Seasons")

div_metrics2 <- left_join(hill, sample_metadata,  by = "SampleID") %>% 
  filter(Season != "Fall") %>% 
  filter(Species %in% c("Elk", "Bison", "BighornSheep")) %>% 
  mutate(group = paste(Species, Season)) %>% 
  group_by(Species, Season, metric) %>% 
  summarise(mean = mean(value), 
           sd = sd(value), 
           n = n()) %>% 
  mutate(ci = 1.95*sd/sqrt(n), 
         se = sd/sqrt(n))
div_metrics <- rbind(div_metrics, div_metrics2) %>% 
  mutate(se = round(se, 2),
         mean = round(mean, 2)) %>% 
  mutate(mean_se = paste(mean, se, sep = " ")) %>% 
  filter(metric == "q0")

div_metrics$Species =factor(div_metrics$Species, levels = c("Bison",  
                                                   "BighornSheep",    "Elk",  "Goat",  "Deer",  "Moose"),
                            labels = c("Bison",  "Bighorn Sheep", "Elk", "Mountain Goat", "Deer",  "Moose"))
div_metrics$Season = factor(div_metrics$Season, levels = c("All Seasons",  "Winter", "Spring", "Summer"))
div_metrics$metric = factor(div_metrics$metric, labels = c("Niche breadth", "Total niche width"))

# let's get a lil plot
ggplot(div_metrics, aes(x = Season, y = mean, color = Species, shape = Species)) + 
  geom_point(position = position_dodge(width = 0.5)) + 
  geom_errorbar(aes(ymin = mean - ci, ymax = mean + ci), position = position_dodge(width = 0.5), width = 0.4) +
  facet_wrap(.~metric, nrow = 1, scales = "free_y") + 
  theme_bw() + 
  ylab("Mean index value per species/season and 95 % C.I.") + xlab(NULL) + 
  scale_color_manual(values = c("firebrick4",  "orange3", "darkorchid",  "orchid1",  "gold",  "darkorange2")) +
  scale_shape_manual(values = c(16, 16, 15, 15, 17, 17)) + 
    theme(
    legend.title = element_blank(),
    panel.grid.major = element_blank(),  # Remove major gridlines
    panel.grid.minor = element_blank()
  ) 

ggsave("Outputs/FOO_all_species_diversity_noSeason_dec072024.jpeg", width = 10, height = 6)



```


Intraspecific niche differentiation based on betadisp

trying to get dispersion (intraspecific differences!) based on some of Beth's YNP code - yes, it wokrs!
```{r}

sample_data(physeq_foo)$Species_Season = paste(sample_data(physeq_foo)$Species, sample_data(physeq_foo)$Season)
# subsetting ot season 
physeq_foo_core <-subset_samples(physeq_foo, Season != "Fall" & (Species == "Bison" | Species == "BighornSheep" | Species == "Elk"))
bray_dist_core <- phyloseq::distance(physeq_foo_core, method = "bray")
bray_dist <- phyloseq::distance(physeq_foo, method = "bray")

# calculate!! 
beta_core <- betadisper(bray_dist_core, group=sample_data(physeq_foo_core)$Species_Season, 
                        bias.adjust = TRUE, type = "centroid")
beta_core
beta_allspp <- betadisper(bray_dist, bias.adjust = TRUE, type = "centroid", group=sample_data(physeq_foo)$Species)
beta_allspp
# YES there are significant differences between groups!! 
permutest(beta_core, permutations = how(nperm=999), pairwise = TRUE)
permutest(beta_allspp, permutations = how(nperm=999), pairwise = TRUE)

# but which groups? 
tukey_szn <- TukeyHSD(beta_core)[["group"]]
tukey_allspp <- TukeyHSD(beta_allspp)[["group"]]

write.csv(tukey_allspp, "Outputs/FOO_intraspecific_diet_dissimilarity_comparisons_tukey.csv")

write.csv(tukey_szn, "Outputs/FOO_seasonal_intraspecific_diet_dissimilarity_comparisons_tukey.csv")

```



Niche overlap based on adonis2
```{r}
## comparing across all species (indepdent of season)
diet_matrix <- t(otu_table(physeq_foo)) # get our community matrix
covar_table <- data.frame(sample_data(physeq_foo))
class(covar_table)
# run adonis test... community data matrix ~ covariate (rows in community matrix match rows in covar data frame)
mod1 <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray",
    parallel = 15, na.action = na.fail)
mod1


## season-species perMANOVA 
diet_matrix <- t(otu_table(physeq_foo_core)) # get our community matrix
covar_table <- data.frame(sample_data(physeq_foo_core))
class(covar_table)
# run adonis test... community data matrix ~ covariate (rows in community matrix match rows in covar data frame)
season_mod <- adonis2(diet_matrix ~ Species*Season, data = covar_table, permutations = 999, 
                method = "bray",
    parallel = 15, na.action = na.fail)

season_mod


```

oordination figure 
```{r}
GP.ord <- ordinate(physeq_foo , "NMDS", "bray", trymax=300) # run ordination 

sample_data(physeq_foo)$Species = factor(sample_data(physeq_foo)$Species, 
                                         levels = c("Bison", "BighornSheep",  "Elk", "Goat",  "Deer", "Moose" ), 
                                         labels = c("Bison", "Bighorn Sheep", "Elk",
                                                     "Mountain Goat",  "Deer Spp.", "Moose"))
table(sample_data(physeq_foo)$Species)

sample_data(physeq_foo)$Season = factor(sample_data(physeq_foo)$Season, levels = c("Winter", "Spring", "Summer")) 

ordination_RRA_dat = plot_ordination(physeq_foo, GP.ord, color = "Species", shape = "Species", type="samples", justDF = TRUE)

# special snowflake 
special_snowflake  <-ordination_RRA_dat %>% 
  group_by(Species, Season) %>% 
  summarise(mean_nmds1 = mean(NMDS1), 
          mean_nmds2 = mean(NMDS2),
          se_nmds1 = sd(NMDS1)/sqrt(n_distinct(SampleID)), 
          se_nmds2 = sd(NMDS2)/sqrt(n_distinct(SampleID)))

ordination_RRA <- ggplot(ordination_RRA_dat, aes(x = NMDS1, y = NMDS2*-1, 
                                                 color = Species, linetype = Species, shape = Species)) +
  geom_point(size = 1.5, alpha =0.3) + 
#  geom_point(data = special_snowflake, aes(x = mean_nmds1, y = mean_nmds2*-1), size = 2) + 
 # geom_errorbar(data = special_snowflake, aes(ymax = ((mean_nmds2 + se_nmds2)*-1), ymin = ((mean_nmds2-se_nmds2)*-1), 
#                                              x = mean_nmds1, y = -1*mean_nmds2), linewidth = 1) +
#  geom_errorbarh(data = special_snowflake, aes(xmax = mean_nmds1 + se_nmds1, xmin = mean_nmds1-se_nmds1, 
#                                               x = mean_nmds1, y = -1*mean_nmds2), linewidth = 1) + 

  stat_chull(aes(fill = Species, linetype = Species), geom = "polygon", alpha = 0.1, size = 0.2) + 
  scale_fill_manual(values = c("firebrick4",  "orange3", "darkorchid4", "orchid1", "gold", "darkorange2")) +   
    scale_color_manual(values = c("firebrick4",  "orange3", "darkorchid",  "orchid1",   "gold", "darkorange2")) +
  scale_shape_manual(values = c(16, 16, 15, 15, 17, 17)) + 
  scale_linetype_manual(values = c("solid",  "solid", "dashed", "dashed", "dotted", "dotted")) + 
  ylab("NMDS2") + 
     theme_bw() + 
  theme(legend.position ="right",# c(0.75, 0.23), 
          panel.grid.major = element_blank(),  # Remove major gridlines
          panel.grid.minor = element_blank()) + 
 # geom_text(aes(label = ID_Number), vjust = -0.5) + 
  facet_wrap(.~Season)
ordination_RRA
ggsave("Outputs/FOO_all_species_dietoord_seasons_feb222025.jpeg", ordination_RRA, height = 3, width = 10)




# checking out within-season overlap for bison/elk/sheeps
# WITHIN season differences 

sp <- subset_samples(physeq_foo_core, Season == "Spring")
diet_matrix <- t(otu_table(sp)) # get our community matrix
covar_table <- data.frame(sample_data(sp))
sp_adonis <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
sp_adonis

# SPRING SIMPER analysis
sp_simper_result <- simper(diet_matrix, covar_table$Species, permutations = 999)
summary(sp_simper_result)

su <- subset_samples(physeq_foo_core, Season == "Summer")
diet_matrix <- t(otu_table(su)) # get our community matrix
covar_table <- data.frame(sample_data(su))
su_adonis <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
su_adonis
su_simper_result <- simper(diet_matrix, covar_table$Species, permutations = 999)
summary(su_simper_result)



w <- subset_samples(physeq_foo_core, Season == "Winter" | Season == "Fall")
diet_matrix <- t(otu_table(w)) # get our community matrix
covar_table <- data.frame(sample_data(w))
w_adonis <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
w_adonis
w_simper_result <- simper(diet_matrix, covar_table$Species, permutations = 999)
summary(w_simper_result)

```


overlap across morphological feeding modes 
```{r}
sample_data(physeq_foo)$feeding_mode <- if_else(sample_data(physeq_foo)$Species == "Bison" | 
                                                  sample_data(physeq_foo)$Species == "BighornSheep", "Grazer", 
                                if_else(sample_data(physeq_foo)$Species == "Moose" | 
                                          sample_data(physeq_foo)$Species== "Deer", "Browser", "Mixed"))

# group species by functional feeding more and see if permanova differentiates them... use spicy pairwise comparisons too!! 
diet_matrix <- t(otu_table(physeq_foo)) # get our community matrix
covar_table <- data.frame(sample_data(physeq_foo)) 
# run adonis test... community data matrix ~ covariate (rows in community matrix match rows in covar data frame)
table(covar_table$feeding_mode)
ffmode_mod <- adonis2(diet_matrix ~ feeding_mode, data = covar_table, permutations = 999, 
                method = "bray",
    parallel = 15, na.action = na.fail)

ffmode_mod


# group species by functional feeding more and see if permanova differentiates them... use spicy pairwise comparisons too!! 
graz_browse <- subset_samples(physeq_foo, (feeding_mode == "Grazer" # filter for bison, elk, sheep
                                                      | feeding_mode == "Browser"))

diet_matrix <- t(otu_table(graz_browse)) # get our community matrix
covar_table <- data.frame(sample_data(graz_browse)) 
# run adonis test... community data matrix ~ covariate (rows in community matrix match rows in covar data frame)
table(covar_table$feeding_mode)
ffmode_mod <- adonis2(diet_matrix ~ feeding_mode, data = covar_table, permutations = 999, 
                method = "bray",
    parallel = 15, na.action = na.fail)

ffmode_mod

## graz graz! 
graz_browse <- subset_samples(physeq_foo, (feeding_mode == "Grazer" # filter for bison, elk, sheep
                                                      | feeding_mode == "Mixed"))

diet_matrix <- t(otu_table(graz_browse)) # get our community matrix
covar_table <- data.frame(sample_data(graz_browse)) 
# run adonis test... community data matrix ~ covariate (rows in community matrix match rows in covar data frame)
table(covar_table$feeding_mode)
ffmode_mod <- adonis2(diet_matrix ~ feeding_mode, data = covar_table, permutations = 999, 
                method = "bray",
    parallel = 15, na.action = na.fail)

ffmode_mod
p.adjust(ffmode_mod$`Pr(>F)`, "holm", n = 3) 


graz_browse <- subset_samples(physeq_foo, (feeding_mode == "Browser" # filter for bison, elk, sheep
                                                      | feeding_mode == "Mixed"))

diet_matrix <- t(otu_table(graz_browse)) # get our community matrix
covar_table <- data.frame(sample_data(graz_browse)) 
# run adonis test... community data matrix ~ covariate (rows in community matrix match rows in covar data frame)
table(covar_table$feeding_mode)
ffmode_mod <- adonis2(diet_matrix ~ feeding_mode, data = covar_table, permutations = 999, 
                method = "bray",
    parallel = 15, na.action = na.fail)

ffmode_mod

p.adjust(ffmode_mod$`Pr(>F)`, "holm", n = 3) 
```



```{r}
######## PAIRWISE COMPARISONS 

# bison sheep 
bis_bhs <- subset_samples(physeq_foo, Species == "Bison" | Species == "BighornSheep")
diet_matrix <- t(otu_table(bis_bhs)) # get our community matrix
covar_table <- data.frame(sample_data(bis_bhs))
bis_bhs_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)

# bison elk 
bis_elk <- subset_samples(physeq_foo, Species == "Bison" | (Species == "Elk" & Long < -115.4105))
diet_matrix <- t(otu_table(bis_elk)) # get our community matrix
covar_table <- data.frame(sample_data(bis_elk))
bis_elk_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)

# bison deer
bis_deer  <- subset_samples(physeq_foo, Species == "Bison" | Species == "Deer")
diet_matrix <- t(otu_table(bis_deer)) # get our community matrix
covar_table <- data.frame(sample_data(bis_deer))
bis_deer_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_deer_pair

# bis goat 
bis_goat  <- subset_samples(physeq_foo, Species == "Bison" | Species == "Goat")
diet_matrix <- t(otu_table(bis_goat)) # get our community matrix
covar_table <- data.frame(sample_data(bis_goat))
bis_goat_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_goat_pair

# bis moose 
bis_moose  <- subset_samples(physeq_foo, Species == "Bison" | Species == "Moose")
diet_matrix <- t(otu_table(bis_moose)) # get our community matrix
covar_table <- data.frame(sample_data(bis_moose))
bis_moose_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_moose_pair

# bighorn slk 
dat  <- subset_samples(physeq_foo, Species == "BighornSheep" | Species == "Elk")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
bhs_elk_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bhs_elk_pair

# bighorn goat 
dat  <- subset_samples(physeq_foo, Species == "BighornSheep" | Species == "Goat")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
bhs_goat_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bhs_goat_pair

# bighorn deer 
dat  <- subset_samples(physeq_foo, Species == "BighornSheep" | Species == "Deer")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
bhs_deer_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bhs_deer_pair

# bighorn moose 
dat  <- subset_samples(physeq_foo, Species == "BighornSheep" | Species == "Moose")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
bhs_moose_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bhs_moose_pair

# elk - goat 
dat  <- subset_samples(physeq_foo, Species == "Elk" | Species == "Goat")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
elk_goat_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
elk_goat_pair

# elk - deer 
dat  <- subset_samples(physeq_foo, Species == "Elk" | Species == "Deer")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
elk_deer_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
elk_deer_pair

# elk - moose 
dat  <- subset_samples(physeq_foo, Species == "Elk" | Species == "Moose")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
elk_moose_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
elk_moose_pair

## goat - deer 
dat  <- subset_samples(physeq_foo, Species == "Goat" | Species == "Deer")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
goat_deer_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
goat_deer_pair

## goat - moose 
dat  <- subset_samples(physeq_foo, Species == "Goat" | Species == "Moose")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
goat_moose_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
goat_moose_pair

## deer - moose
dat  <- subset_samples(physeq_foo, Species == "Deer" | Species == "Moose")
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
deer_moose_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
deer_moose_pair

# get our adjusted p values
pairwise.species <- data.frame(species = c("bis_bhs", "bis_elk", "bis_deer", "bis_goat", "bis_moose", 
                                           "bhs_elk", "bhs_goat", "bhs_deer", "bhs_moose", 
                                           "elk_goat", "elk_deer", "elk_moose", 
                                           "goat_deer", "goat_moose", 
                                           "deer_moose"), 
                              rsq = c(bis_bhs_pair$R2[1],
                                        bis_elk_pair$R2[1], 
                                        bis_deer_pair$R2[1],
                                        bis_goat_pair$R2[1],
                                        bis_moose_pair$R2[1], 
                                      #
                                      bhs_elk_pair$R2[1],
                                        bhs_goat_pair$R2[1], 
                                        bhs_deer_pair$R2[1],
                                        bis_moose_pair$R2[1], 
                                      #
                                        elk_goat_pair$R2[1],
                                        elk_deer_pair$R2[1], 
                                        elk_moose_pair$R2[1], 
                                      #
                                       goat_deer_pair$R2[1],
                                       goat_moose_pair$R2[1],
                                      #
                                        deer_moose_pair$R2[1]),
                                  pseudoF = c(bis_bhs_pair$F[1],
                                        bis_elk_pair$F[1], 
                                        bis_deer_pair$F[1],
                                        bis_goat_pair$F[1],
                                        bis_moose_pair$F[1], 
                                      #
                                      bhs_elk_pair$F[1],
                                        bhs_goat_pair$F[1], 
                                        bhs_deer_pair$F[1],
                                        bis_moose_pair$F[1], 
                                      #
                                        elk_goat_pair$F[1],
                                        elk_deer_pair$F[1], 
                                        elk_moose_pair$F[1], 
                                      #
                                       goat_deer_pair$F[1],
                                       goat_moose_pair$F[1],
                                      #
                                        deer_moose_pair$R2[1]),
                                  pval = c(bis_bhs_pair$`Pr(>F)`[1],
                                        bis_elk_pair$`Pr(>F)`[1], 
                                        bis_deer_pair$`Pr(>F)`[1],
                                        bis_goat_pair$`Pr(>F)`[1],
                                        bis_moose_pair$`Pr(>F)`[1], 
                                      #
                                      bhs_elk_pair$`Pr(>F)`[1],
                                        bhs_goat_pair$`Pr(>F)`[1], 
                                        bhs_deer_pair$`Pr(>F)`[1],
                                        bis_moose_pair$`Pr(>F)`[1], 
                                      #
                                        elk_goat_pair$`Pr(>F)`[1],
                                        elk_deer_pair$`Pr(>F)`[1], 
                                        elk_moose_pair$`Pr(>F)`[1], 
                                      #
                                       goat_deer_pair$`Pr(>F)`[1],
                                       goat_moose_pair$`Pr(>F)`[1],
                                      #
                                        deer_moose_pair$`Pr(>F)`[1]),
                                  
                                body_diff = c(550, 375, 545, 555, 225, # bison
                                              175, 5, 5, 375, # bhs
                                              180, 170, 200, # moose
                                              10, 380, 370 # deer and goat 
                                              ), 
                              comparison = c("within", "between", "between", "between", "between", 
                                             "between", "between", "between", "between", 
                                             "within", "between", "between", 
                                             "between", "between", 
                                             "within"))


pairwise.species$holm <-   p.adjust(pairwise.species$pval, "holm") 


write.csv(pairwise.species, "Outputs/FOO_pairwise_comparisons_across_all_species_dec082024.csv")

### BODY SIZE INVESTIGATION!!! 

hist(log(pairwise.species$rsq)) # not normally distirbuted.... log transforming helps 
hist(pairwise.species$body_diff)


body_size_lm <- lm(log(rsq) ~ log(body_diff), data = pairwise.species)
summary(body_size_lm)

cor.test(pairwise.species$rsq, pairwise.species$body_diff, method = "spearman")


ggplot(pairwise.species, aes(x = body_diff, y = rsq)) + 
  geom_point(aes(color = comparison, shape = comparison), size = 3) + 
  ylab("Diet dissimilarity (perMANOVA rsq, log-transformed)") + xlab("Body mass difference") + 
  geom_smooth(method = "lm", se = F, color = "black") + 
  theme_bw()


### Pairwise comparisons across seasons 
 #use adonis to compare species-season.... 
#################### SEASON SPECIFIC COMPARISONS 

# elk and bison winter
bis_elk <- subset_samples(physeq_foo, Season == "Winter" & (Species == "Bison" | Species == "Elk"))
diet_matrix <- t(otu_table(bis_elk)) # get our community matrix
covar_table <- data.frame(sample_data(bis_elk))
bis_elk_w_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_elk_w_pair

# bhs and bison winter
bis_bhs <- subset_samples(physeq_foo, Season == "Winter" & (Species == "Bison" | Species == "BighornSheep"))
diet_matrix <- t(otu_table(bis_bhs)) # get our community matrix
covar_table <- data.frame(sample_data(bis_bhs))
bis_bhs_w_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_bhs_w_pair

# elk and bison spring
bis_elk <- subset_samples(physeq_foo, Season == "Spring" & (Species == "Bison" | Species == "Elk"))
diet_matrix <- t(otu_table(bis_elk)) # get our community matrix
covar_table <- data.frame(sample_data(bis_elk))
bis_elk_sp_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_elk_sp_pair

# bhs and bison spring
bis_bhs <- subset_samples(physeq_foo, Season == "Spring" & (Species == "Bison" | Species == "BighornSheep"))
diet_matrix <- t(otu_table(bis_bhs)) # get our community matrix
covar_table <- data.frame(sample_data(bis_bhs))
bis_bhs_sp_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_bhs_sp_pair

# elk and bison summer
bis_elk <- subset_samples(physeq_foo, Season == "Summer" & (Species == "Bison" | Species == "Elk"))
diet_matrix <- t(otu_table(bis_elk)) # get our community matrix
covar_table <- data.frame(sample_data(bis_elk))
bis_elk_su_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_elk_su_pair

# bhs and bison spring
bis_bhs <- subset_samples(physeq_foo, Season == "Summer" & (Species == "Bison" | Species == "BighornSheep"))
diet_matrix <- t(otu_table(bis_bhs)) # get our community matrix
covar_table <- data.frame(sample_data(bis_bhs))
bis_bhs_su_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bis_bhs_su_pair

# bhs and elk spring
dat <- subset_samples(physeq_foo, Season == "Spring" & (Species == "Elk" | Species == "BighornSheep"))
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
bhs_elk_sp_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bhs_elk_sp_pair

# bjs and elk summer
dat <- subset_samples(physeq_foo, Season == "Summer" & (Species == "Elk" | Species == "BighornSheep"))
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
bhs_elk_su_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bhs_elk_su_pair


# bjs and elk winter
dat <- subset_samples(physeq_foo, Season == "Winter" & (Species == "Elk" | Species == "BighornSheep"))
diet_matrix <- t(otu_table(dat)) # get our community matrix
covar_table <- data.frame(sample_data(dat))
bhs_elk_w_pair <- adonis2(diet_matrix ~ Species, data = covar_table, permutations = 999, 
                method = "bray", parallel = 15, na.action = na.fail)
bhs_elk_w_pair


# vector of p values 
pairwise.seasonal <- data.frame(species = c("bis_elk_w_pair", "bis_bhs_w_pair", "bis_elk_sp_pair", "bis_bhs_sp_pair", 
                                   "bis_elk_su_pair", "bis_bhs_su_pair", 
                                   "bhs_elk_sp", "bhs_elk_su", "bhs_elk_w"),
                      rsq = c(bis_elk_w_pair$R2[1], 
                                  bis_bhs_w_pair$R2[1], 
                                  bis_elk_sp_pair$R2[1], 
                                  bis_bhs_sp_pair$R2[1], 
                                  bis_elk_su_pair$R2[1], 
                                  bis_bhs_su_pair$R2[1],
                              bhs_elk_sp_pair$R2[1],
                              bhs_elk_su_pair$R2[1],
                              bhs_elk_w_pair$R2[1]
                              ), 
                      pseudoF = c(bis_elk_w_pair$F[1], 
                                  bis_bhs_w_pair$F[1], 
                                  bis_elk_sp_pair$F[1], 
                                  bis_bhs_sp_pair$F[1], 
                                  bis_elk_su_pair$F[1], 
                                  bis_bhs_su_pair$F[1], 
                                
                              bhs_elk_sp_pair$F[1],
                              bhs_elk_su_pair$F[1],
                              bhs_elk_w_pair$F[1]),
                       pval = c( bis_elk_w_pair$`Pr(>F)`[1], 
                                  bis_bhs_w_pair$`Pr(>F)`[1], 
                                  bis_elk_sp_pair$`Pr(>F)`[1], 
                                  bis_bhs_sp_pair$`Pr(>F)`[1], 
                                  bis_elk_su_pair$`Pr(>F)`[1], 
                                  bis_bhs_su_pair$`Pr(>F)`[1], 
                                 
                              bhs_elk_sp_pair$`Pr(>F)`[1],
                              bhs_elk_su_pair$`Pr(>F)`[1],
                              bhs_elk_w_pair$`Pr(>F)`[1]))
pairwise.seasonal$holm <-   p.adjust(pairwise.seasonal$pval, "holm") 

write.csv(pairwise.seasonal, "Outputs/FOO_pairwise_comparisons_across_season.csv")

```

Diet dissimilarities across seasons based on simper tests! 
```{r}
bleh <- summary(sp_simper_result)
for(i in 1:length(bleh)){bleh[[i]]$identity = rownames(bleh[[i]])}
df_combined3 <- map_dfr(names(bleh), ~ bleh[[.x]] %>%
                          mutate(Source = .x)) %>% 
 # filter(p < 0.05 & average > 0.005) %>% # only including species w significant partitioning & difference of over 1%
  filter(grepl("Bison", Source)) %>% 
  mutate(Season = "Spring")
bleh <- summary(su_simper_result)
for(i in 1:length(bleh)){bleh[[i]]$identity = rownames(bleh[[i]])}
df_combined2 <- map_dfr(names(bleh), ~ bleh[[.x]] %>%
                          mutate(Source = .x)) %>% 
 # filter(p < 0.05 & average > 0.005) %>% # only including species w significant partitioning & difference of over 1%
  filter(grepl("Bison", Source)) %>% 
  mutate(Season = "Summer")
bleh <- summary(w_simper_result)
for(i in 1:length(bleh)){bleh[[i]]$identity = rownames(bleh[[i]])}
df_combined1 <- map_dfr(names(bleh), ~ bleh[[.x]] %>%
                          mutate(Source = .x)) %>% 
 # filter(p < 0.05 & cumsum > 0.005) %>% # only including species w significant partitioning & difference of over 1%
  filter(grepl("Bison", Source)) %>% 
  mutate(Season = "Winter")


df_combined <- rbind(df_combined1, df_combined2, df_combined3)
df_bis <- df_combined %>% mutate(Species = "Bison", mean_rra = avb) 
df_bhs_elk <-  df_combined %>% mutate(Species = if_else(grepl("Elk", Source), "Elk", "BighornSheep"),
                                      mean_rra = ava) 

df_combined <- rbind(df_bis, df_bhs_elk)

# i need species to be ifelse contains XX, bighorn 


tax_yap <-  data.frame(tax_table(physeq_foo)) %>% 
  dplyr::select(identity, form, best_id, family_name, genus_name, scientific_name, common_name)
df_combined <- merge(df_combined, tax_yap) %>% 
  mutate(alpha = if_else(p < 0.05, 0.95, 0.3))
df_combined$Species <- factor(df_combined$Species, levels = c("Bison", "BighornSheep", "Elk"))
#library(ggimage)
#df_combined$bis <- if_else(df_combined$Species == "Bison", "https://images.phylopic.org/images/d65f6782-5a32-4b77-8448-4081bf1dfa02/vector.svg", NA)
#df_combined$bis <-  "https://images.phylopic.org/images/d65f6782-5a32-4b77-8448-4081bf1dfa02/vector.svg"
#df_combined$bis <-  "https://images.phylopic.org/images/d65f6782-5a32-4b77-8448-4081bf1dfa02/vector.svg"

df_combined$Season = factor(df_combined$Season, levels = c("Winter", "Spring", "Summer"))
df_combined$Source = factor(df_combined$Source, labels = c("Bighorn sheep - Bison", "Elk - Bison"))

# difference has to be more than 1% of proportional RRA 
df_combined %>% filter(best_id != "banana" & p < 0.05 & best_id != "") %>% 
ggplot(., aes(x = best_id, y = mean_rra, fill = Species)) + 
  geom_col(position = position_dodge(width = 0.8),  color = "black") + 
  facet_wrap(Source~Season, scales = "free") + 
  theme_bw() + 
  coord_flip() + 
  scale_fill_manual(values = c( "firebrick","orange2", "orchid")) + #, "gold", "lightyellow2"))
  ylab("Mean plant taxa RRA in species-season sample") + xlab("Plant taxa")

ggsave("Outputs/FOO_simper_results.jpeg", height = 15, width = 12)


```


making a table with all pianka and mean bray-curtis values for each species-season 

```{r}
### using niche.overlap 
all_spp <- niche.overlap(otu_table(physeq_foo), method = "pianka") # calculate pairwise niche overlap 
# using meandist to get the mean distance 
meandist(all_spp,  sample_data(physeq_foo)$Species)

all_spp <- niche.overlap(otu_table(physeq_foo_subset ), method = "pianka") # calculate pairwise niche overlap 
meandist(all_spp,  paste(sample_data(physeq_foo_subset )$Species, sample_data(physeq_foo_subset )$Season))

## bray-curtis 
all_spp_bray <-  vegdist(t(otu_table(physeq_foo)), method = "bray") # calculates bray-curtis dissimilarity 
meandist(all_spp_bray,  sample_data(physeq_foo)$Species)

all_spp_bray <-  vegdist(t(otu_table(physeq_foo_subset )), method = "bray") # calculates bray-curtis dissimilarity 
meandist(all_spp_bray,  paste(sample_data(physeq_foo_subset )$Species, sample_data(physeq_foo_subset )$Season))


```




